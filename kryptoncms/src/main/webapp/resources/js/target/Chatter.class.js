define(["jquery","SocketHandler.class","libraries/mootools-base","message_proxies/ChatMessage.class","Notifier.class","Logger.class","libraries/jquery.cookie"],function($,SocketHandler,Mootools,ChatMessage,Notifier,Logger){var Chatter=new Mootools.Class({Implements:[Mootools.Options],options:{},$elements:null,initialize:function(e){var t=this;t.logger=new Logger("Chatter"),t.socketHandler=null,t.setOptions(e),t.$elements={$destination:$(),$messageBody:$(),$messageBoard:$(),$submitBtn:$(),$chatterForm:$(),$destinationsPallette:$(),$destinationAdderBtn:$()}},attachHandlers:function(){var thisChatterInstance=this;for(var key in thisChatterInstance.$elements)if(thisChatterInstance.$elements[key].length!=1){thisChatterInstance.logger.log("error","aborting chat bcz these element(s) are not right"),thisChatterInstance.logger.log("error",key),thisChatterInstance.logger.log("error",thisChatterInstance.$elements[key]);return}thisChatterInstance.activated=!0,thisChatterInstance.subscribeSocket(),thisChatterInstance.attachSubmitHandler(),thisChatterInstance.attachDestinationAdderHandler(eval(thisChatterInstance.$elements.$destination.attr("data-source")))},subscribeSocket:function(){var e=this;e.socketHandler=(new SocketHandler({url:e.$elements.$chatterForm.attr("action")})).setOnMessageHandler(function(t){e.appendToMessageBoard(JSON.parse(t.responseBody))}).subscribe()}.protect(),attachSubmitHandler:function(){var e=this,t=function(t){var n=e.$elements.$messageBody.val().trim().length>0;n?e.$elements.$submitBtn.removeClass("disabled"):e.$elements.$submitBtn.addClass("disabled")};e.$elements.$messageBody.bind({change:t,keyup:t}),e.$elements.$submitBtn.click(function(){var t={nonEmptyMessage:{isValid:!1,errorMessage:"You can't send an empty message"},takingToOtherPpl:{isValid:!1,errorMessage:"We Can't Let You Talk to Yourself :)"}};t.nonEmptyMessage.isValid=e.$elements.$messageBody.val().trim().length>0,t.takingToOtherPpl.isValid=e.$elements.$destinationsPallette.find("[data-username]").length>0;var n=!0;for(var r in t)n=n&&t[r].isValid;if(n){var i=new ChatMessage;$.cookie("j_username")?i.source=$.cookie("j_username"):i.source="You",i.destinations=[],e.$elements.$destinationsPallette.find("[data-username]").each(function(){i.destinations.push($(this).attr("data-username"))}),i.body=e.$elements.$messageBody.val(),e.appendToMessageBoard(i),e.socketHandler.push(JSON.stringify(i)),e.$elements.$messageBody.val(""),e.logger.log("info","outgoing message"),e.logger.log("debug","destinations are "),e.logger.log("debug",i.destinations),e.logger.log("debug","message is "+i.body)}else for(var r in t)if(t[r].isValid==0){Notifier.getInstance().notify(t[r].errorMessage,"MEDIUM","VERY_FAST","alert-error");break}})}.protect(),attachDestinationAdderHandler:function(e){var t=this,n=function(n){var r=t.$elements.$destination.val();e.indexOf(r)<0?t.$elements.$destinationAdderBtn.addClass("disabled"):t.$elements.$destinationAdderBtn.removeClass("disabled")};t.$elements.$destination.bind({change:n,keyup:n}),t.$elements.$destinationAdderBtn.click(function(){var n=t.$elements.$destination.val(),r={nonempty:{isValid:!1,errorMessage:"You forgot to enter a username"},registeredUser:{isValid:!1,errorMessage:'"'+n+'" is not a registered user'},notDuplicate:{isValid:!1,errorMessage:'"'+n+'" is already added to the conversation'}};r.registeredUser.isValid=e.indexOf(n)>-1,r.nonempty.isValid=n.trim()!=="",r.notDuplicate.isValid=t.$elements.$destinationsPallette.find('[data-username="'+n+'"]').length==0;var i=!0;for(var s in r)i=i&&r[s].isValid;if(i)$("#destination-pallette-item-tmpl").tmpl({destination:n}).appendTo(t.$elements.$destinationsPallette),t.$elements.$destination.val("");else for(var s in r)if(r[s].isValid==0){Notifier.getInstance().notify(r[s].errorMessage,"MEDIUM","VERY_FAST","alert-error");break}})}.protect(),appendToMessageBoard:function(e){$("#chat-message-tmpl").tmpl(e).appendTo(this.$elements.$messageBoard),this.$elements.$messageBoard.get(0).scrollTop=this.$elements.$messageBoard.get(0).scrollHeight},closeSockets:function(){this.socketHandler.close()}});return Chatter});