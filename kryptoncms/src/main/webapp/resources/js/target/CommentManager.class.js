define(["jquery","SocketHandler.class","libraries/mootools-base","Logger.class","./libraries/jquery.tmpl"],function(e,t,n,r){var i=new n.Class({logger:null,children:[],initialize:function(t,n){this.isRoot=!1,this.logger=new r("CommentManager"),typeof t=="undefined"?(t=e("body").keydown(e.proxy(function(t){var n=t.keyCode===27;n&&this.hideCommentInput(e("[data-reply-input]"))},this)),this.isRoot=!0,this.root=this):this.root=n,this.logger.log("debug","tree"),this.logger.log("debug",this.root.children),this.refreshContext(t)},subscribeSocket:function(){if(!this.isRoot)return;var n=this;n.socketHandler=(new t({url:n.channelPath})).setOnMessageHandler(function(t){try{var r=JSON.parse(t.responseBody);r.successful==1&&e.each(r.queryResult,function(t,r){var i="[data-commentable-type][data-comment-containter][data-commentable-type="+r.parentType+"][data-commentable-id="+r.parentId+"]",s=e(i+":not(.hide):first");if(s.length===1){var o=e("#comments-tmpl").tmpl(r);o.appendTo(s)}s=e(i);var u=s.parent().prev("[data-show-replies-btn]").attr("disabled",null),a=u.find("[data-show-replies-text]"),f=a.text();a.text(parseInt(f)+1),n.attachReplyHandler(e(i).find("[data-reply-button]")),n.attachHandlerToRepliesToggler(e(i).find("button"))})}catch(i){}}).subscribe()},refreshContext:function(t){var n=this;n.$commentSections=[],t.find("[data-enable-comments]").each(function(){n.$commentSections.push({$element:e(this),data_server_service_prefix_url:e(this).closest("[data-server-service-prefix-url]").attr("data-server-service-prefix-url")});if(n.isRoot){var t=e(this).closest("[data-server-service-prefix-url]"),r=t.find("[data-enable-comments]");n.channelPath=t.attr("data-server-service-prefix-url")+"socket/"+r.attr("data-commentable-type")+"/"+r.attr("data-commentable-id"),n.subscribeSocket()}})},attachHandlersToSections:function(){var t=this;if(t.$commentSections.length<=0){t.logger.log("debug","this page is clean ... aborting");return}t.activated=!0;var n=[];return t.$commentSections.each(function(r){n.push(e.ajax({url:r.data_server_service_prefix_url+r.$element.attr("data-commentable-type")+"/"+r.$element.attr("data-commentable-id"),type:"GET",dataType:"json",cache:!1,contentType:"application/json",success:function(n){if(n.successful){n["queryResult"]==null&&(n.queryResult=[]),t.logger.log("debug","all went well"),t.logger.log("debug",n.queryResult);var i=e("#comments-tmpl").tmpl(n.queryResult);i.appendTo(r.$element);var s=r.$element.find("[data-reply-button]");t.attachReplyHandler(s),t.attachHandlerToRepliesToggler(r.$element.find("button"))}else t.logger.log("error",n.errorMessage)},error:function(e){t.logger.log("error","error in the HTTP request check the XHR Stacktrace")}}))}),n},attachHandlerToRepliesToggler:function(t){var n,r=this;t.unbind("click");var s=!0;t.click(function(t){if(s)e(this).attr("disabled","").toggleClass("dropup").find(".annotate").each(function(){e(this).toggleClass("hide")}),n=new i(e(this).parent(),r.root),r.children.push(n),e.when(n.attachHandlersToSections()).then(e.proxy(function(){e(this).attr("disabled",null).parent().find("[data-enable-comments]").removeClass("hide").hide(0).slideDown()},this));else{var o=e(this);o.attr("disabled","").toggleClass("dropup").find(".annotate").each(function(){e(this).toggleClass("hide")}),e(this).parent().find("[data-enable-comments]").slideUp(function(){e(this).html("").addClass("hide"),o.attr("disabled",null)}),r.root.killNode(n)}s=!s})},attachReplyHandler:function(t){var n=this;t.unbind("click"),t.click(function(){var t=e(this);t.hide(0),t.next("[data-reply-input]").removeClass("hide").hide(0).show(function(){var t=e(this);e("[data-reply-input]").each(function(){e(this).is(t)||n.hideCommentInput(e(this))}),t.addClass("input-block-level"),typeof t.attr("data-event-keydown")=="undefined"&&t.keydown(function(r){var i=!r.shiftKey&&r.keyCode===13;i&&(r.preventDefault(),n.submitComment({parentId:t.parent().attr("data-commentable-id"),commentableType:t.parent().attr("data-commentable-type"),content:e(this).val()}),n.hideCommentInput(e(this)))}).attr("data-event-keydown","")})})},hideCommentInput:function(e){e.val("").hide(200,function(){e.prev("[data-reply-button]").show(0)})},submitComment:function(e){this.logger.log("debug","sending this"),this.logger.log("debug",e),this.root.socketHandler.push(JSON.stringify(e))},killNode:function(e){for(var t=0;t<this.children.length;++t){this.children[t].killNode(e);if(this.children[t]===e){for(var n=0;n<this.children[t].children.length;n++)this.children[t].killNode(this.children[t].children[n]);this.children.splice(t,1);return}}},closeSockets:function(){this.socketHandler.close()}});return i});